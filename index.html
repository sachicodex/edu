<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LearnSphere Tutorials</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Lucide Icons CDN (for Search, BookOpen, MessageSquare, X, Send, Loader2 icons) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /* Custom global styles */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            margin: 0;
            background-color: #0F172A; /* gray-950 */
            color: #F3F4F6; /* gray-100 */
            overflow-x: hidden;
            padding: 1.5rem; /* p-6 */
        }

        /* Custom scrollbar for dark theme */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #1a202c; /* Dark background */
        }
        ::-webkit-scrollbar-thumb {
            background: #4a5568; /* Grayish thumb */
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #6b7280; /* Lighter gray on hover */
        }

        /* Custom scrollbar for chatbot messages */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: #374151; /* Darker gray for track */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #6b7280; /* Lighter gray for thumb */
            border-radius: 3px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #9ca3af; /* Even lighter gray on hover */
        }

        /* Fade-in-up animation for chatbot */
        @keyframes fadeInMoveUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .animate-fade-in-up {
            animation: fadeInMoveUp 0.3s ease-out forwards;
        }

        /* Modal specific styles (removed as summary modal is removed) */
        /*
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #1a202c;
            margin: auto;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
            animation: fadeIn 0.3s ease-out;
            position: relative;
            border: 1px solid #4a5568;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .close-button {
            color: #aaa;
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            transition: color 0.2s;
        }

        .close-button:hover,
        .close-button:focus {
            color: #fff;
            text-decoration: none;
            cursor: pointer;
        }
        */
    </style>
</head>
<body class="min-h-screen bg-gray-950 text-gray-100 font-inter overflow-x-hidden p-6">

    <!-- Tutorials Section -->
    <section class="py-12 px-4 bg-gray-950">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-pink-400 mb-10">Our Popular Tutorials</h1>
        <p class="text-center text-gray-300 mb-10 max-w-2xl mx-auto text-lg">
            Explore our curated collection of tutorials. Use the search bar below to find exactly what you're looking for!
        </p>

        <!-- Search Bar -->
        <div class="max-w-xl mx-auto mb-12 relative">
            <input
                type="text"
                id="searchTermInput"
                placeholder="Search for tutorials (e.g., React, Figma, JavaScript basics)..."
                class="w-full p-4 pl-12 bg-gray-800 border border-gray-700 rounded-full text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-purple-500 transition duration-200"
            />
            <div class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-search"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
            </div>
            <div id="searchLoader" class="hidden absolute right-4 top-1/2 -translate-y-1/2 text-purple-400 animate-spin">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
            </div>
        </div>

        <!-- Tutorial Grid -->
        <div id="tutorialGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-10 max-w-7xl mx-auto">
            <!-- Initial loading message -->
            <div id="initialLoadingMessage" class="col-span-full text-center text-gray-400 text-xl py-20">
                Loading tutorials...
                <div class="mt-4">
                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-loader-2 animate-spin mx-auto text-purple-400"><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>
                </div>
            </div>
            <!-- Tutorials will be rendered here by JavaScript -->
        </div>
        <div id="noResultsMessage" class="text-center text-gray-400 text-xl py-20 hidden">
            No tutorials found matching your search. Try a different query!
        </div>
    </section>

    <!-- Floating Chatbot Button -->
    <button
        id="chatbotToggleButton"
        class="fixed bottom-6 right-6 bg-pink-600 hover:bg-pink-700 text-white p-4 rounded-full shadow-lg z-50 transform hover:scale-110 transition duration-300 ease-in-out focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 focus:ring-offset-gray-900"
        aria-label="Toggle Chatbot"
    >
        <svg id="chatbotOpenIcon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-message-square"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
        <svg id="chatbotCloseIcon" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x hidden"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
    </button>

    <!-- Chatbot Widget -->
    <div id="chatbotContainer" class="fixed bottom-4 right-4 w-80 md:w-96 bg-gray-800 rounded-lg shadow-2xl flex flex-col z-50 border border-gray-700 hidden">
        <div class="flex justify-between items-center bg-gray-700 p-3 rounded-t-lg border-b border-gray-600">
            <h3 class="text-lg font-semibold text-purple-300">Chat with AI</h3>
            <button id="chatbotCloseButton" class="text-gray-400 hover:text-white transition duration-200">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-x"><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>
            </button>
        </div>
        <div id="messagesContainer" class="flex-1 p-4 overflow-y-auto max-h-80 custom-scrollbar">
            <p id="initialChatbotMessage" class="text-gray-400 text-center text-sm italic">
                Hello! How can I assist you with LearnSphere tutorials today?
            </p>
            <!-- Messages will be appended here -->
        </div>
        <div class="p-3 border-t border-gray-600 flex items-center rounded-b-lg">
            <input
                type="text"
                id="chatInput"
                placeholder="Type your message..."
                class="flex-1 p-2 bg-gray-700 border border-gray-600 rounded-lg text-gray-100 placeholder-gray-400 focus:outline-none focus:ring-1 focus:ring-purple-500"
            />
            <button
                id="sendMessageButton"
                class="ml-2 p-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg transition duration-200 focus:outline-none focus:ring-2 focus:ring-pink-500 focus:ring-offset-2 focus:ring-offset-gray-800"
            >
                <!-- Changed to Lucide Send icon -->
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-send"><path d="m22 2-7 20-4-9-9-4 20-7z"/></svg>
            </button>
        </div>
    </div>

    <!-- Footer -->
    <footer class="bg-gray-900 py-8 text-center text-gray-500 text-sm rounded-t-xl mt-12">
        <p>&copy; <span id="currentYear"></span> LearnSphere. All rights reserved.</p>
        <p>Empowering Your Learning Journey</p>
    </footer>

    <script>
        let allTutorials = []; // This will now be populated dynamically from JSON files
        let filteredTutorials = [];
        let isSearching = false;
        let searchTimeout;

        // List of tutorial file names (corresponding to tutorial IDs and .json filenames)
        // This array will be AUTOMATICALLY UPDATED by the Node.js script.
        // DO NOT EDIT THIS MANUALLY IF YOU ARE USING THE AUTOMATION SCRIPT.
        const tutorialFileNames = [
            'tds',
            'electronics'
        ];

        // --- Utility Functions ---
        function debounce(func, delay) {
            let timeout;
            return function(...args) {
                const context = this;
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(context, args), delay);
            };
        }

        // --- Tutorial Data Loading ---
        async function loadTutorialsFromFiles() {
            const initialLoadingMessage = document.getElementById('initialLoadingMessage');
            initialLoadingMessage.classList.remove('hidden'); // Show loading message

            const fetchedTutorials = [];
            for (const fileName of tutorialFileNames) {
                try {
                    // Fetching .json files from the 'tutorials' subfolder
                    const response = await fetch(`tutorials/${fileName}.json`);
                    if (!response.ok) {
                        console.error(`Failed to fetch tutorials/${fileName}.json: ${response.status} ${response.statusText}`);
                        continue; // Skip to the next file if one fails
                    }
                    const tutorialData = await response.json(); // Parsing as JSON
                    fetchedTutorials.push(tutorialData);
                } catch (fetchError) {
                    console.error(`Error fetching or parsing tutorials/${fileName}.json:`, fetchError);
                }
            }
            allTutorials = fetchedTutorials;
            filteredTutorials = [...allTutorials]; // Initialize filtered with all loaded tutorials
            initialLoadingMessage.classList.add('hidden'); // Hide loading message
            renderTutorials(filteredTutorials); // Render after loading
        }


        // --- Tutorial Rendering ---
        function renderTutorials(tutorialsToRender) {
            const tutorialGrid = document.getElementById('tutorialGrid');
            const noResultsMessage = document.getElementById('noResultsMessage');
            tutorialGrid.innerHTML = ''; // Clear existing tutorials

            if (tutorialsToRender.length === 0) {
                noResultsMessage.classList.remove('hidden');
                if (isSearching) {
                    noResultsMessage.textContent = 'Searching for tutorials...';
                } else {
                    noResultsMessage.textContent = 'No tutorials found matching your search. Try a different query!';
                }
                return;
            } else {
                noResultsMessage.classList.add('hidden');
            }

            tutorialsToRender.forEach(tutorial => {
                const cardHtml = `
                    <div class="bg-gray-900 rounded-xl shadow-xl overflow-hidden group hover:shadow-purple-500/50 hover:shadow-2xl transform hover:scale-105 transition duration-300 ease-in-out border border-gray-700 hover:border-purple-500 hover:ring-2 hover:ring-purple-500 relative">
                        <img
                            src="${tutorial.imageUrl}"
                            alt="${tutorial.title}"
                            class="w-full h-48 object-cover group-hover:opacity-80 transition duration-300"
                            onerror="this.onerror=null;this.src='https://placehold.co/600x400/374151/d1d5db?text=Image+Error';"
                        />
                        <div class="p-6">
                            <h3 class="text-2xl font-semibold text-purple-300 mb-2">${tutorial.title}</h3>
                            <p class="text-gray-400 text-sm mb-4">
                                ${tutorial.description}
                            </p>
                            <div class="flex flex-wrap gap-2 mb-4">
                                ${tutorial.tags.map(tag => `<span class="bg-gray-700 text-gray-300 text-xs px-3 py-1 rounded-full">${tag}</span>`).join('')}
                            </div>
                            <div class="flex justify-end mt-4">
                                <a
                                    href="${tutorial.link}"
                                    target="_blank"
                                    rel="noopener noreferrer"
                                    class="text-pink-400 hover:text-pink-300 font-medium flex items-center space-x-1"
                                >
                                    Start Tutorial <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-book-open"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"/><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"/></svg>
                                </a>
                            </div>
                        </div>
                    </div>
                `;
                tutorialGrid.insertAdjacentHTML('beforeend', cardHtml);
            });

            // Removed event listeners for summary buttons as the feature is removed.
        }

        // --- AI Search Functionality ---
        async function performAISearch(query) {
            if (query.trim() === '') {
                filteredTutorials = [...allTutorials];
                isSearching = false;
                renderTutorials(filteredTutorials);
                document.getElementById('searchLoader').classList.add('hidden');
                return;
            }

            isSearching = true;
            document.getElementById('searchLoader').classList.remove('hidden');
            renderTutorials([]); // Show "Searching..." message

            try {
                // Prompt for search functionality
                const prompt = `You are an intelligent tutorial search assistant for LearnSphere. Your primary goal is to find the most relevant tutorial IDs based on a user's query, making the search experience user-friendly and highly engaging.

Here is the list of available tutorials, including their IDs, titles, descriptions, and tags (which represent categories, subjects, and skill levels):
${allTutorials.map(t => `- ID: ${t.id}, Title: ${t.title}, Description: ${t.description}, Tags: ${t.tags.join(', ')}`).join('\n')}

User Query: "${query}"

Instructions for Advanced Search:
1.  **Interpret and Refine Query:**
    * **Spelling Correction:** First, intelligently correct any obvious spelling mistakes or typos in the user's query (e.g., "electnic" should be understood as "electronic").
    * **Summarization/Intent Extraction:** If the query is long, conversational, or vague, distill it down to its core intent, key topics, and relevant keywords. Focus on what the user *really* wants to learn.
2.  **Advanced Analysis:**
    * **Category/Subject Inference:** Infer relevant categories or subjects from the refined query (e.g., 'wire' -> 'electronics', 'design' -> 'UI/UX', 'ML' -> 'Machine Learning', 'tax' -> 'Finance').
    * **Skill Level Detection:** Identify any specified skill levels (e.g., 'advanced', 'beginner', 'basics', 'mastering', 'intro').
    * **Synonym and Related Concepts:** Consider synonyms and closely related concepts to broaden the search intelligently.
3.  **Relevance Matching:** Find the tutorial IDs that are most relevant based on a combination of:
    * Direct keyword matches (from the refined query).
    * Inferred categories/subjects.
    * Detected skill levels.
    * Overall semantic similarity to the tutorial content.
    Prioritize results that offer the best match across these criteria.
4.  **Output Format:** Respond ONLY with a comma-separated list of the 'id's of the relevant tutorials. Do not include any other text, explanations, or formatting. If no tutorials are relevant after your analysis, respond with "none".

Examples of expected output based on various queries:
- Query: "electnic advanced" -> Example Output: electronics,advanced-electronics-tutorial-id (assuming such an advanced electronics tutorial exists and is relevant)
- Query: "basics of figma" -> Example Output: figma-ui-design
- Query: "how to build a website with react" -> Example Output: react-hooks-mastery,nodejs-rest-apis
- Query: "learn about wire" -> Example Output: electronics
- Query: "I want to get into creating digital art for web interfaces, something for people who are just starting out" -> Example Output: graphic-design-basics,figma-ui-design
- Query: "complex grid layouts for responsive pages" -> Example Output: advanced-css-grid`;

                const chatHistory = [{ role: "user", parts: [{ text: prompt }] }];
                const payload = { contents: chatHistory };
                // --- IMPORTANT: Your Gemini API Key for GitHub Pages deployment ---
                const apiKey = "AIzaSyDY5VgoB8_Rvlmna0xPfiRow3FD2VrheQw"; // Re-inserted API Key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    console.error(`API Error: ${response.status} - ${response.statusText} - ${errorText}`);
                    throw new Error(`API returned an error: ${response.statusText || 'Unknown Error'}`);
                }

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const aiResponse = result.candidates[0].content.parts[0].text.trim();
                    console.log("AI Search Response:", aiResponse);
                    if (aiResponse.toLowerCase() === 'none' || aiResponse === '') {
                        filteredTutorials = [];
                    } else {
                        const relevantIds = aiResponse.split(',').map(id => id.trim());
                        filteredTutorials = allTutorials.filter(tutorial => relevantIds.includes(tutorial.id));
                    }
                } else {
                    console.warn("AI search response unexpected or empty, falling back to client-side search.");
                    fallbackClientSideSearch(query);
                }
            } catch (error) {
                console.error('Error during AI search:', error);
                fallbackClientSideSearch(query);
            } finally {
                isSearching = false;
                renderTutorials(filteredTutorials);
                document.getElementById('searchLoader').classList.add('hidden');
            }
        }

        // Fallback search now only checks title, description, and tags
        function fallbackClientSideSearch(query) {
            const lowerCaseQuery = query.toLowerCase();
            filteredTutorials = allTutorials.filter(tutorial =>
                tutorial.title.toLowerCase().includes(lowerCaseQuery) ||
                tutorial.description.toLowerCase().includes(lowerCaseQuery) ||
                tutorial.tags.some(tag => tag.toLowerCase().includes(lowerCaseQuery))
            );
        }

        // --- Chatbot Functionality (Rebuilt) ---
        const chatMessages = []; // Stores the chat history for context
        let isChatbotLoading = false; // Prevents multiple simultaneous API calls

        /**
         * Appends a message to the chatbot's message container.
         * @param {string} sender - 'user' or 'bot'
         * @param {string} text - The message text
         */
        function appendMessage(sender, text) {
            const messagesContainer = document.getElementById('messagesContainer');
            const initialMessage = document.getElementById('initialChatbotMessage');

            // Remove initial message once the first message (user or bot) is appended
            if (initialMessage) {
                initialMessage.remove();
            }

            const messageDiv = document.createElement('div');
            messageDiv.classList.add('mb-3');
            messageDiv.classList.add(sender === 'user' ? 'text-right' : 'text-left');

            const messageSpan = document.createElement('span');
            messageSpan.classList.add('inline-block', 'p-2', 'rounded-lg', 'max-w-[80%]');
            if (sender === 'user') {
                messageSpan.classList.add('bg-purple-600', 'text-white');
            } else {
                messageSpan.classList.add('bg-gray-700', 'text-gray-100');
            }
            messageSpan.textContent = text;
            messageDiv.appendChild(messageSpan);
            messagesContainer.appendChild(messageDiv);

            // Scroll to the bottom to show the latest message
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        /**
         * Toggles the visibility of the chatbot loading indicator.
         * @param {boolean} show - True to show, false to hide.
         */
        function showChatbotLoading(show) {
            const messagesContainer = document.getElementById('messagesContainer');
            let loadingDiv = document.getElementById('chatbotLoadingDiv');

            if (show) {
                if (!loadingDiv) {
                    loadingDiv = document.createElement('div');
                    loadingDiv.id = 'chatbotLoadingDiv';
                    loadingDiv.classList.add('text-left', 'mb-3');
                    loadingDiv.innerHTML = `<span class="inline-block p-2 rounded-lg bg-gray-700 text-gray-100">Thinking...</span>`;
                    messagesContainer.appendChild(loadingDiv);
                }
                messagesContainer.scrollTop = messagesContainer.scrollHeight; // Scroll to show thinking message
            } else {
                if (loadingDiv) {
                    loadingDiv.remove(); // Remove the loading indicator
                }
            }
        }

        /**
         * Sends a message to the Gemini API and handles the response for the chatbot.
         */
        async function sendChatMessage() {
            const chatInput = document.getElementById('chatInput');
            const message = chatInput.value.trim();

            if (message === '') return; // Don't send empty messages
            if (isChatbotLoading) return; // Prevent multiple sends

            // Append user message to UI and clear input
            appendMessage('user', message);
            chatInput.value = '';

            // Disable input and button, show loading indicator
            isChatbotLoading = true;
            chatInput.disabled = true;
            document.getElementById('sendMessageButton').disabled = true;
            showChatbotLoading(true);

            try {
                let botResponseText;

                // Check for specific "who are you" query
                if (message.toLowerCase() === 'who are you') {
                    botResponseText = 'Name : Sachintha Lakshan';
                } else {
                    // Prepare chat history for the API call
                    // Include a system instruction to guide the AI's persona and knowledge base
                    let chatHistory = [{
                        role: "user",
                        parts: [{ text: "You are a helpful assistant for LearnSphere, an online tutorial platform. Answer questions about web development, UI/UX design, programming (like JavaScript, React, Node.js, Java), CSS, HTML, and general learning. Keep your answers concise and directly related to learning or our tutorials. Do not engage in topics outside of LearnSphere's educational content. If asked about something unrelated, politely redirect to our tutorials. " }]
                    }];

                    // Add previous messages to history for context, limiting to a few for efficiency
                    // Ensure roles are 'user' or 'model' for the API
                    const recentMessages = chatMessages.slice(Math.max(chatMessages.length - 6, 0)); // Keep last 6 messages for context
                    recentMessages.forEach(msg => {
                        chatHistory.push({ role: msg.sender === 'user' ? 'user' : 'model', parts: [{ text: msg.text }] });
                    });

                    // Add the current user message
                    chatHistory.push({ role: "user", parts: [{ text: message }] });

                    const payload = { contents: chatHistory };
                    // --- IMPORTANT: Your Gemini API Key for GitHub Pages deployment ---
                    const apiKey = "AIzaSyDY5VgoB8_Rvlmna0xPfiRow3FD2VrheQw"; // Re-inserted API Key
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorText = await response.text();
                        console.error(`Chatbot API Error: ${response.status} - ${response.statusText} - ${errorText}`);
                        throw new Error(`API returned an error: ${response.statusText || 'Unknown Error'}`);
                    }

                    const result = await response.json();
                    console.log("Chatbot AI Raw Response:", result); // Log raw response for debugging

                    if (result.candidates && result.candidates.length > 0 &&
                        result.candidates[0].content && result.candidates[0].content.parts &&
                        result.candidates[0].content.parts.length > 0) {
                        botResponseText = result.candidates[0].content.parts[0].text;
                    } else {
                        console.warn("Chatbot AI response structure unexpected or empty.");
                        botResponseText = "Sorry, I couldn't get a clear response. Can you please rephrase?";
                    }
                }

                // Append bot's response to UI and history
                appendMessage('bot', botResponseText);
                chatMessages.push({ sender: 'bot', text: botResponseText });

            } catch (error) {
                console.error('Error during chatbot API call:', error);
                appendMessage('bot', "Oops! Something went wrong on my end. Please try again later.");
            } finally {
                // Re-enable input and button, hide loading indicator
                isChatbotLoading = false;
                chatInput.disabled = false;
                document.getElementById('sendMessageButton').disabled = false;
                showChatbotLoading(false);
            }
        }

        /**
         * Toggles the visibility of the chatbot widget.
         */
        function toggleChatbot() {
            const chatbotContainer = document.getElementById('chatbotContainer');
            const openIcon = document.getElementById('chatbotOpenIcon');
            const closeIcon = document.getElementById('chatbotCloseIcon');

            if (chatbotContainer.classList.contains('hidden')) {
                chatbotContainer.classList.remove('hidden');
                chatbotContainer.classList.add('animate-fade-in-up');
                openIcon.classList.add('hidden');
                closeIcon.classList.remove('hidden');
            } else {
                chatbotContainer.classList.add('hidden');
                chatbotContainer.classList.remove('animate-fade-in-up');
                openIcon.classList.remove('hidden');
                closeIcon.classList.add('hidden');
            }
        }

        // --- Event Listeners and Initial Setup ---
        document.addEventListener('DOMContentLoaded', () => {
            // Set current year in footer
            document.getElementById('currentYear').textContent = new Date().getFullYear();

            // Load tutorials from files
            loadTutorialsFromFiles(); // This function will now fetch from JSON files

            // Search input event listener with debounce
            const searchTermInput = document.getElementById('searchTermInput');
            searchTermInput.addEventListener('input', debounce((e) => {
                performAISearch(e.target.value);
            }, 200));

            // Chatbot button listeners
            document.getElementById('chatbotToggleButton').addEventListener('click', toggleChatbot);
            document.getElementById('chatbotCloseButton').addEventListener('click', toggleChatbot);
            document.getElementById('sendMessageButton').addEventListener('click', sendChatMessage);
            document.getElementById('chatInput').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });

            // Removed event listeners for summary modal as the feature is removed.
            // document.getElementById('closeSummaryModal').addEventListener('click', () => {
            //     document.getElementById('summaryModal').style.display = 'none';
            // });

            // window.addEventListener('click', (event) => {
            //     const summaryModal = document.getElementById('summaryModal');
            //     if (event.target === summaryModal) {
            //         summaryModal.style.display = 'none';
            //     }
            // });
        });
    </script>
</body>
</html>
